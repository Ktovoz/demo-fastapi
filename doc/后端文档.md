# åç«¯æ–‡æ¡£

<!-- 
æ–‡æ¡£ç®¡ç†è§„èŒƒ:
- å†…å®¹ï¼šåŒ…å«åç«¯æŠ€æœ¯æ ˆå’Œå…·ä½“å®ç°ç»†èŠ‚
- ç›®çš„ï¼šè¯¦ç»†è®°å½•åç«¯å¼€å‘æ‰€ä½¿ç”¨çš„æŠ€æœ¯ã€æ¡†æ¶åŠå…·ä½“å®ç°æ–¹å¼
è¯·AIåœ¨ç¼–è¾‘æ­¤æ–‡æ¡£æ—¶éµå®ˆä¸Šè¿°è§„èŒƒ
-->

## æŠ€æœ¯æ ˆ

### Webæ¡†æ¶
- **FastAPI 0.104.1** - ç°ä»£ã€å¿«é€Ÿçš„Webæ¡†æ¶ï¼Œæ”¯æŒè‡ªåŠ¨APIæ–‡æ¡£ç”Ÿæˆ
- **Uvicorn 0.24.0[standard]** - ASGIæœåŠ¡å™¨ï¼Œæ”¯æŒHTTP/2å’ŒWebSocket

### æ•°æ®åº“å’ŒORM
- **SQLite** - è½»é‡çº§æ–‡ä»¶æ•°æ®åº“ï¼Œé€‚åˆå¼€å‘å’Œå°å‹éƒ¨ç½²
- **SQLAlchemy** - Python SQLå·¥å…·åŒ…å’Œå¯¹è±¡å…³ç³»æ˜ å°„(ORM)
- **Alembic** - æ•°æ®åº“è¿ç§»å·¥å…·

### æ•°æ®éªŒè¯å’Œåºåˆ—åŒ–
- **Pydantic 2.5.0** - æ•°æ®éªŒè¯å’Œåºåˆ—åŒ–åº“ï¼Œæ”¯æŒç±»å‹æ³¨è§£

### èº«ä»½è®¤è¯å’Œå®‰å…¨
- **python-jose[cryptography] 3.3.0** - JWT Tokenå¤„ç†
- **passlib[bcrypt] 1.7.4** - å¯†ç å“ˆå¸Œå’ŒéªŒè¯
- **python-multipart 0.0.6** - æ–‡ä»¶ä¸Šä¼ æ”¯æŒ

### é…ç½®å’Œç¯å¢ƒ
- **python-dotenv 1.0.0** - ç¯å¢ƒå˜é‡ç®¡ç†
- **Pydantic Settings** - é…ç½®ç®¡ç†

### æ—¥å¿—å’Œç›‘æ§
- **Loguru 0.7.2** - ç®€æ´é«˜æ•ˆçš„æ—¥å¿—åº“
- **å†…ç½®ç»“æ„åŒ–æ—¥å¿—æ”¯æŒ**

### HTTPå®¢æˆ·ç«¯
- **httpx 0.25.2** - å¼‚æ­¥HTTPå®¢æˆ·ç«¯

### å¼€å‘å·¥å…·
- **pytest** - æµ‹è¯•æ¡†æ¶
- **black** - ä»£ç æ ¼å¼åŒ–
- **isort** - å¯¼å…¥æ’åº
- **mypy** - ç±»å‹æ£€æŸ¥

## é¡¹ç›®ç»“æ„

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ core/                   # æ ¸å¿ƒé…ç½®æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ config.py           # åº”ç”¨é…ç½®
â”‚   â”‚   â”œâ”€â”€ security.py         # å®‰å…¨ç›¸å…³é…ç½®
â”‚   â”‚   â””â”€â”€ database.py         # æ•°æ®åº“é…ç½®
â”‚   â”œâ”€â”€ models/                 # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py             # åŸºç¡€æ¨¡å‹ç±»
â”‚   â”‚   â”œâ”€â”€ user.py             # ç”¨æˆ·æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ role.py             # è§’è‰²æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ permission.py       # æƒé™æ¨¡å‹
â”‚   â”‚   â””â”€â”€ operation_log.py    # æ“ä½œæ—¥å¿—æ¨¡å‹
â”‚   â”œâ”€â”€ schemas/                # Pydanticæ•°æ®æ¨¡å¼
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py             # åŸºç¡€æ¨¡å¼
â”‚   â”‚   â”œâ”€â”€ user.py             # ç”¨æˆ·æ¨¡å¼
â”‚   â”‚   â”œâ”€â”€ auth.py             # è®¤è¯æ¨¡å¼
â”‚   â”‚   â”œâ”€â”€ role.py             # è§’è‰²æ¨¡å¼
â”‚   â”‚   â””â”€â”€ common.py           # é€šç”¨æ¨¡å¼
â”‚   â”œâ”€â”€ routers/                # APIè·¯ç”±
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ auth.py             # è®¤è¯è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ users.py            # ç”¨æˆ·ç®¡ç†è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ roles.py            # è§’è‰²ç®¡ç†è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ dashboard.py        # ä»ªè¡¨æ¿è·¯ç”±
â”‚   â”‚   â””â”€â”€ system.py           # ç³»ç»Ÿç®¡ç†è·¯ç”±
â”‚   â”œâ”€â”€ services/               # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user_service.py     # ç”¨æˆ·æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ auth_service.py     # è®¤è¯æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ role_service.py     # è§’è‰²æœåŠ¡
â”‚   â”‚   â””â”€â”€ system_service.py   # ç³»ç»ŸæœåŠ¡
â”‚   â”œâ”€â”€ utils/                  # å·¥å…·æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ logger.py           # æ—¥å¿—å·¥å…·
â”‚   â”‚   â”œâ”€â”€ dependencies.py     # ä¾èµ–æ³¨å…¥
â”‚   â”‚   â”œâ”€â”€ security.py         # å®‰å…¨å·¥å…·
â”‚   â”‚   â””â”€â”€ decorators.py       # è£…é¥°å™¨
â”‚   â””â”€â”€ main.py                 # åº”ç”¨å…¥å£
â”œâ”€â”€ alembic/                    # æ•°æ®åº“è¿ç§»
â”‚   â”œâ”€â”€ versions/               # è¿ç§»ç‰ˆæœ¬
â”‚   â”œâ”€â”€ env.py                  # è¿ç§»ç¯å¢ƒ
â”‚   â””â”€â”€ alembic.ini             # è¿ç§»é…ç½®
â”œâ”€â”€ data/                       # æ•°æ®åº“æ–‡ä»¶ç›®å½•
â”œâ”€â”€ tests/                      # æµ‹è¯•æ–‡ä»¶
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ conftest.py             # æµ‹è¯•é…ç½®
â”‚   â”œâ”€â”€ test_auth.py            # è®¤è¯æµ‹è¯•
â”‚   â”œâ”€â”€ test_users.py           # ç”¨æˆ·æµ‹è¯•
â”‚   â””â”€â”€ test_utils.py           # å·¥å…·æµ‹è¯•
â”œâ”€â”€ .env.example                # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ .gitignore                  # Gitå¿½ç•¥æ–‡ä»¶
â”œâ”€â”€ requirements.txt            # Pythonä¾èµ–
â”œâ”€â”€ requirements-dev.txt        # å¼€å‘ä¾èµ–
â”œâ”€â”€ pyproject.toml              # é¡¹ç›®é…ç½®
â”œâ”€â”€ alembic.ini                 # Alembicé…ç½®
â”œâ”€â”€ pytest.ini                 # æµ‹è¯•é…ç½®
â””â”€â”€ run.py                      # è¿è¡Œè„šæœ¬
```

## å®ç°ç»†èŠ‚

### æ ¸å¿ƒé…ç½®æ¨¡å—

#### 1. åº”ç”¨é…ç½® (core/config.py)
```python
from pydantic_settings import BaseSettings
from typing import Optional
import secrets

class Settings(BaseSettings):
    # åº”ç”¨åŸºç¡€é…ç½®
    APP_NAME: str = "åå°ç®¡ç†Demoç³»ç»Ÿ"
    APP_VERSION: str = "1.0.0"
    DEBUG: bool = False

    # æœåŠ¡å™¨é…ç½®
    HOST: str = "0.0.0.0"
    PORT: int = 8000

    # å®‰å…¨é…ç½®
    SECRET_KEY: str = secrets.token_urlsafe(32)
    ALGORITHM: str = "HS256"
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 30
    REFRESH_TOKEN_EXPIRE_MINUTES: int = 7 * 24 * 60  # 7å¤©

    # æ•°æ®åº“é…ç½®
    DATABASE_URL: str = "sqlite:///./data/app.db"

    # æ—¥å¿—é…ç½®
    LOG_LEVEL: str = "INFO"
    LOG_FILE: str = "logs/app.log"
    LOG_ROTATION: str = "10 MB"
    LOG_RETENTION: str = "7 days"

    # CORSé…ç½®
    BACKEND_CORS_ORIGINS: list[str] = [
        "http://localhost:3000",
        "http://localhost:5173",
        "http://127.0.0.1:3000",
    ]

    # ç”¨æˆ·é…ç½®
    DEFAULT_ADMIN_USERNAME: str = "admin"
    DEFAULT_ADMIN_PASSWORD: str = "admin123"
    DEFAULT_ADMIN_EMAIL: str = "admin@example.com"

    # åˆ†é¡µé…ç½®
    DEFAULT_PAGE_SIZE: int = 10
    MAX_PAGE_SIZE: int = 100

    class Config:
        env_file = ".env"
        case_sensitive = True

# åˆ›å»ºå…¨å±€é…ç½®å®ä¾‹
settings = Settings()
```

#### 2. æ•°æ®åº“é…ç½® (core/database.py)
```python
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker, Session
from sqlalchemy.pool import StaticPool
from typing import Generator
import os

from .config import settings
from ..utils.logger import get_logger

logger = get_logger(__name__)

# åˆ›å»ºæ•°æ®åº“å¼•æ“
engine = create_engine(
    settings.DATABASE_URL,
    connect_args={
        "check_same_thread": False,  # SQLiteç‰¹æœ‰é…ç½®
    },
    poolclass=StaticPool,  # SQLiteä½¿ç”¨é™æ€è¿æ¥æ± 
    echo=settings.DEBUG  # å¼€å‘æ¨¡å¼ä¸‹æ‰“å°SQLè¯­å¥
)

# åˆ›å»ºä¼šè¯å·¥å‚
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# åˆ›å»ºåŸºç¡€æ¨¡å‹ç±»
Base = declarative_base()

def get_db() -> Generator[Session, None, None]:
    """è·å–æ•°æ®åº“ä¼šè¯"""
    db = SessionLocal()
    try:
        yield db
    except Exception as e:
        logger.error(f"æ•°æ®åº“ä¼šè¯é”™è¯¯: {e}")
        db.rollback()
        raise
    finally:
        db.close()

def init_db():
    """åˆå§‹åŒ–æ•°æ®åº“"""
    try:
        # ç¡®ä¿æ•°æ®ç›®å½•å­˜åœ¨
        os.makedirs(os.path.dirname(settings.DATABASE_URL.replace("sqlite:///", "")), exist_ok=True)

        # åˆ›å»ºæ‰€æœ‰è¡¨
        Base.metadata.create_all(bind=engine)
        logger.info("æ•°æ®åº“è¡¨åˆ›å»ºæˆåŠŸ")

        # åˆå§‹åŒ–é»˜è®¤æ•°æ®
        from ..services.init_service import init_default_data
        init_default_data()

        logger.info("æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ")
    except Exception as e:
        logger.error(f"æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: {e}")
        raise
```

### æ•°æ®æ¨¡å‹å®šä¹‰

#### 1. åŸºç¡€æ¨¡å‹ (models/base.py)
```python
from sqlalchemy import Column, Integer, DateTime, Boolean
from sqlalchemy.sql import func
from typing import Any
from ..core.database import Base

class BaseModel(Base):
    """åŸºç¡€æ¨¡å‹ç±»"""
    __abstract__ = True

    id = Column(Integer, primary_key=True, index=True, autoincrement=True)
    created_at = Column(DateTime(timezone=True), server_default=func.now(), comment="åˆ›å»ºæ—¶é—´")
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now(), comment="æ›´æ–°æ—¶é—´")
    is_active = Column(Boolean, default=True, comment="æ˜¯å¦å¯ç”¨")

    def to_dict(self) -> dict[str, Any]:
        """è½¬æ¢ä¸ºå­—å…¸"""
        return {
            column.name: getattr(self, column.name)
            for column in self.__table__.columns
        }

    def update_from_dict(self, data: dict[str, Any]) -> None:
        """ä»å­—å…¸æ›´æ–°å±æ€§"""
        for key, value in data.items():
            if hasattr(self, key) and key not in ['id', 'created_at']:
                setattr(self, key, value)
```

#### 2. ç”¨æˆ·æ¨¡å‹ (models/user.py)
```python
from sqlalchemy import Column, String, DateTime, Boolean
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from typing import List

from .base import BaseModel

class User(BaseModel):
    """ç”¨æˆ·æ¨¡å‹"""
    __tablename__ = "users"

    username = Column(String(50), unique=True, index=True, nullable=False, comment="ç”¨æˆ·å")
    email = Column(String(100), unique=True, index=True, nullable=False, comment="é‚®ç®±")
    password_hash = Column(String(255), nullable=False, comment="å¯†ç å“ˆå¸Œ")
    full_name = Column(String(100), comment="å…¨å")
    avatar = Column(String(255), comment="å¤´åƒURL")
    is_superuser = Column(Boolean, default=False, comment="æ˜¯å¦è¶…çº§ç”¨æˆ·")
    last_login = Column(DateTime(timezone=True), comment="æœ€åç™»å½•æ—¶é—´")

    # å…³ç³»
    user_roles = relationship("UserRole", back_populates="user", cascade="all, delete-orphan")
    roles = relationship("Role", secondary="user_roles", back_populates="users")
    operation_logs = relationship("OperationLog", back_populates="user")

    def __repr__(self):
        return f"<User(username='{self.username}', email='{self.email}')>"

    def has_role(self, role_name: str) -> bool:
        """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŒ‡å®šè§’è‰²"""
        return any(role.name == role_name for role in self.roles)

    def has_permission(self, permission_name: str) -> bool:
        """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŒ‡å®šæƒé™"""
        for role in self.roles:
            for permission in role.permissions:
                if permission.name == permission_name:
                    return True
        return False

    def get_permissions(self) -> List[str]:
        """è·å–ç”¨æˆ·æ‰€æœ‰æƒé™"""
        permissions = []
        for role in self.roles:
            permissions.extend([p.name for p in role.permissions])
        return list(set(permissions))
```

#### 3. è§’è‰²å’Œæƒé™æ¨¡å‹ (models/role.py, models/permission.py)
```python
# models/role.py
from sqlalchemy import Column, String, Text, Boolean
from sqlalchemy.orm import relationship
from typing import List

from .base import BaseModel

class Role(BaseModel):
    """è§’è‰²æ¨¡å‹"""
    __tablename__ = "roles"

    name = Column(String(50), unique=True, index=True, nullable=False, comment="è§’è‰²åç§°")
    description = Column(String(200), comment="è§’è‰²æè¿°")

    # å…³ç³»
    user_roles = relationship("UserRole", back_populates="role", cascade="all, delete-orphan")
    users = relationship("User", secondary="user_roles", back_populates="roles")
    role_permissions = relationship("RolePermission", back_populates="role", cascade="all, delete-orphan")
    permissions = relationship("Permission", secondary="role_permissions", back_populates="roles")

    def __repr__(self):
        return f"<Role(name='{self.name}', description='{self.description}')>"

# models/permission.py
from sqlalchemy import Column, String, Text
from sqlalchemy.orm import relationship

from .base import BaseModel

class Permission(BaseModel):
    """æƒé™æ¨¡å‹"""
    __tablename__ = "permissions"

    name = Column(String(100), unique=True, index=True, nullable=False, comment="æƒé™åç§°")
    resource = Column(String(50), nullable=False, comment="èµ„æºåç§°")
    action = Column(String(50), nullable=False, comment="æ“ä½œç±»å‹")
    description = Column(String(200), comment="æƒé™æè¿°")

    # å…³ç³»
    role_permissions = relationship("RolePermission", back_populates="permission", cascade="all, delete-orphan")
    roles = relationship("Role", secondary="role_permissions", back_populates="permissions")

    def __repr__(self):
        return f"<Permission(name='{self.name}', resource='{self.resource}', action='{self.action}')>"

# models/user_role.py (å…³è”è¡¨)
from sqlalchemy import Column, Integer, ForeignKey
from sqlalchemy.orm import relationship

from .base import BaseModel

class UserRole(BaseModel):
    """ç”¨æˆ·è§’è‰²å…³è”è¡¨"""
    __tablename__ = "user_roles"

    user_id = Column(Integer, ForeignKey("users.id"), nullable=False, comment="ç”¨æˆ·ID")
    role_id = Column(Integer, ForeignKey("roles.id"), nullable=False, comment="è§’è‰²ID")

    # å…³ç³»
    user = relationship("User", back_populates="user_roles")
    role = relationship("Role", back_populates="user_roles")

    def __repr__(self):
        return f"<UserRole(user_id={self.user_id}, role_id={self.role_id})>"

# models/role_permission.py (å…³è”è¡¨)
class RolePermission(BaseModel):
    """è§’è‰²æƒé™å…³è”è¡¨"""
    __tablename__ = "role_permissions"

    role_id = Column(Integer, ForeignKey("roles.id"), nullable=False, comment="è§’è‰²ID")
    permission_id = Column(Integer, ForeignKey("permissions.id"), nullable=False, comment="æƒé™ID")

    # å…³ç³»
    role = relationship("Role", back_populates="role_permissions")
    permission = relationship("Permission", back_populates="role_permissions")

    def __repr__(self):
        return f"<RolePermission(role_id={self.role_id}, permission_id={self.permission_id})>"
```

### æ•°æ®æ¨¡å¼å®šä¹‰

#### 1. ç”¨æˆ·æ¨¡å¼ (schemas/user.py)
```python
from pydantic import BaseModel, EmailStr, Field, validator
from typing import Optional, List
from datetime import datetime

from .base import BaseResponse, BasePaginationResponse

class UserBase(BaseModel):
    """ç”¨æˆ·åŸºç¡€æ¨¡å¼"""
    username: str = Field(..., min_length=3, max_length=50, description="ç”¨æˆ·å")
    email: EmailStr = Field(..., description="é‚®ç®±")
    full_name: Optional[str] = Field(None, max_length=100, description="å…¨å")
    avatar: Optional[str] = Field(None, description="å¤´åƒURL")
    is_active: bool = Field(True, description="æ˜¯å¦å¯ç”¨")

class UserCreate(UserBase):
    """åˆ›å»ºç”¨æˆ·æ¨¡å¼"""
    password: str = Field(..., min_length=6, max_length=50, description="å¯†ç ")
    role_ids: Optional[List[int]] = Field(default=[], description="è§’è‰²IDåˆ—è¡¨")

    @validator('username')
    def validate_username(cls, v):
        if not v.isalnum() and '_' not in v:
            raise ValueError('ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿')
        return v

    @validator('password')
    def validate_password(cls, v):
        if len(v) < 6:
            raise ValueError('å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½')
        return v

class UserUpdate(BaseModel):
    """æ›´æ–°ç”¨æˆ·æ¨¡å¼"""
    email: Optional[EmailStr] = Field(None, description="é‚®ç®±")
    full_name: Optional[str] = Field(None, max_length=100, description="å…¨å")
    avatar: Optional[str] = Field(None, description="å¤´åƒURL")
    is_active: Optional[bool] = Field(None, description="æ˜¯å¦å¯ç”¨")
    role_ids: Optional[List[int]] = Field(None, description="è§’è‰²IDåˆ—è¡¨")

class UserResponse(UserBase):
    """ç”¨æˆ·å“åº”æ¨¡å¼"""
    id: int
    is_superuser: bool
    last_login: Optional[datetime]
    created_at: datetime
    updated_at: datetime
    roles: List['RoleResponse'] = Field(default=[], description="ç”¨æˆ·è§’è‰²")

    class Config:
        from_attributes = True

class UserLogin(BaseModel):
    """ç”¨æˆ·ç™»å½•æ¨¡å¼"""
    username: str = Field(..., description="ç”¨æˆ·åæˆ–é‚®ç®±")
    password: str = Field(..., description="å¯†ç ")

class UserChangePassword(BaseModel):
    """ä¿®æ”¹å¯†ç æ¨¡å¼"""
    old_password: str = Field(..., description="æ—§å¯†ç ")
    new_password: str = Field(..., min_length=6, max_length=50, description="æ–°å¯†ç ")

class UserListResponse(BasePaginationResponse):
    """ç”¨æˆ·åˆ—è¡¨å“åº”æ¨¡å¼"""
    items: List[UserResponse] = Field(..., description="ç”¨æˆ·åˆ—è¡¨")

# é¿å…å¾ªç¯å¯¼å…¥ï¼Œåœ¨æ–‡ä»¶åº•éƒ¨å®šä¹‰
from .role import RoleResponse
UserResponse.model_rebuild()
```

#### 2. è®¤è¯æ¨¡å¼ (schemas/auth.py)
```python
from pydantic import BaseModel, Field
from typing import Optional, List

class Token(BaseModel):
    """Tokenæ¨¡å¼"""
    access_token: str = Field(..., description="è®¿é—®ä»¤ç‰Œ")
    refresh_token: str = Field(..., description="åˆ·æ–°ä»¤ç‰Œ")
    token_type: str = Field("bearer", description="ä»¤ç‰Œç±»å‹")
    expires_in: int = Field(..., description="è¿‡æœŸæ—¶é—´(ç§’)")

class TokenData(BaseModel):
    """Tokenæ•°æ®æ¨¡å¼"""
    user_id: Optional[int] = None
    username: Optional[str] = None
    permissions: List[str] = Field(default=[], description="ç”¨æˆ·æƒé™")
    roles: List[str] = Field(default=[], description="ç”¨æˆ·è§’è‰²")

class LoginResponse(BaseModel):
    """ç™»å½•å“åº”æ¨¡å¼"""
    token: Token = Field(..., description="ä»¤ç‰Œä¿¡æ¯")
    user: 'UserResponse' = Field(..., description="ç”¨æˆ·ä¿¡æ¯")

    class Config:
        from_attributes = True

class RefreshTokenRequest(BaseModel):
    """åˆ·æ–°Tokenè¯·æ±‚æ¨¡å¼"""
    refresh_token: str = Field(..., description="åˆ·æ–°ä»¤ç‰Œ")

# é¿å…å¾ªç¯å¯¼å…¥
from .user import UserResponse
LoginResponse.model_rebuild()
```

### ä¸šåŠ¡é€»è¾‘æœåŠ¡

#### 1. ç”¨æˆ·æœåŠ¡ (services/user_service.py)
```python
from sqlalchemy.orm import Session
from sqlalchemy import and_, or_
from typing import Optional, List, Dict, Any
from datetime import datetime

from ..models.user import User
from ..models.role import Role
from ..schemas.user import UserCreate, UserUpdate
from ..core.security import get_password_hash, verify_password
from ..utils.logger import get_logger
from .auth_service import get_user_permissions

logger = get_logger(__name__)

class UserService:
    """ç”¨æˆ·æœåŠ¡ç±»"""

    def __init__(self, db: Session):
        self.db = db

    def get_user_by_id(self, user_id: int) -> Optional[User]:
        """æ ¹æ®IDè·å–ç”¨æˆ·"""
        try:
            user = self.db.query(User).filter(User.id == user_id).first()
            if user:
                logger.debug(f"è·å–ç”¨æˆ·æˆåŠŸ: {user.username}")
            return user
        except Exception as e:
            logger.error(f"è·å–ç”¨æˆ·å¤±è´¥: {e}")
            return None

    def get_user_by_username(self, username: str) -> Optional[User]:
        """æ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ·"""
        try:
            user = self.db.query(User).filter(
                or_(User.username == username, User.email == username)
            ).first()
            if user:
                logger.debug(f"æ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ·æˆåŠŸ: {username}")
            return user
        except Exception as e:
            logger.error(f"æ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ·å¤±è´¥: {e}")
            return None

    def get_users(
        self,
        skip: int = 0,
        limit: int = 10,
        username: Optional[str] = None,
        email: Optional[str] = None,
        is_active: Optional[bool] = None
    ) -> tuple[List[User], int]:
        """è·å–ç”¨æˆ·åˆ—è¡¨"""
        try:
            query = self.db.query(User)

            # æ„å»ºè¿‡æ»¤æ¡ä»¶
            if username:
                query = query.filter(User.username.contains(username))
            if email:
                query = query.filter(User.email.contains(email))
            if is_active is not None:
                query = query.filter(User.is_active == is_active)

            # è·å–æ€»æ•°
            total = query.count()

            # åˆ†é¡µæŸ¥è¯¢
            users = query.offset(skip).limit(limit).all()

            logger.info(f"è·å–ç”¨æˆ·åˆ—è¡¨æˆåŠŸ: {len(users)}æ¡è®°å½•")
            return users, total
        except Exception as e:
            logger.error(f"è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥: {e}")
            return [], 0

    def create_user(self, user_data: UserCreate) -> Optional[User]:
        """åˆ›å»ºç”¨æˆ·"""
        try:
            # æ£€æŸ¥ç”¨æˆ·åå’Œé‚®ç®±æ˜¯å¦å·²å­˜åœ¨
            existing_user = self.db.query(User).filter(
                or_(User.username == user_data.username, User.email == user_data.email)
            ).first()

            if existing_user:
                if existing_user.username == user_data.username:
                    raise ValueError("ç”¨æˆ·åå·²å­˜åœ¨")
                else:
                    raise ValueError("é‚®ç®±å·²å­˜åœ¨")

            # åˆ›å»ºç”¨æˆ·
            user = User(
                username=user_data.username,
                email=user_data.email,
                password_hash=get_password_hash(user_data.password),
                full_name=user_data.full_name,
                avatar=user_data.avatar,
                is_active=user_data.is_active
            )

            self.db.add(user)
            self.db.commit()
            self.db.refresh(user)

            # åˆ†é…è§’è‰²
            if user_data.role_ids:
                roles = self.db.query(Role).filter(Role.id.in_(user_data.role_ids)).all()
                user.roles = roles
                self.db.commit()

            logger.info(f"åˆ›å»ºç”¨æˆ·æˆåŠŸ: {user.username}")
            return user
        except Exception as e:
            self.db.rollback()
            logger.error(f"åˆ›å»ºç”¨æˆ·å¤±è´¥: {e}")
            raise

    def update_user(self, user_id: int, user_data: UserUpdate) -> Optional[User]:
        """æ›´æ–°ç”¨æˆ·"""
        try:
            user = self.get_user_by_id(user_id)
            if not user:
                return None

            # æ£€æŸ¥é‚®ç®±æ˜¯å¦é‡å¤
            if user_data.email and user_data.email != user.email:
                existing_user = self.db.query(User).filter(
                    and_(User.email == user_data.email, User.id != user_id)
                ).first()
                if existing_user:
                    raise ValueError("é‚®ç®±å·²å­˜åœ¨")

            # æ›´æ–°ç”¨æˆ·ä¿¡æ¯
            update_data = user_data.dict(exclude_unset=True)
            role_ids = update_data.pop('role_ids', None)

            for field, value in update_data.items():
                setattr(user, field, value)

            user.updated_at = datetime.utcnow()

            # æ›´æ–°è§’è‰²
            if role_ids is not None:
                roles = self.db.query(Role).filter(Role.id.in_(role_ids)).all()
                user.roles = roles

            self.db.commit()
            self.db.refresh(user)

            logger.info(f"æ›´æ–°ç”¨æˆ·æˆåŠŸ: {user.username}")
            return user
        except Exception as e:
            self.db.rollback()
            logger.error(f"æ›´æ–°ç”¨æˆ·å¤±è´¥: {e}")
            raise

    def delete_user(self, user_id: int) -> bool:
        """åˆ é™¤ç”¨æˆ·"""
        try:
            user = self.get_user_by_id(user_id)
            if not user:
                return False

            # è½¯åˆ é™¤
            user.is_active = False
            user.updated_at = datetime.utcnow()

            self.db.commit()

            logger.info(f"åˆ é™¤ç”¨æˆ·æˆåŠŸ: {user.username}")
            return True
        except Exception as e:
            self.db.rollback()
            logger.error(f"åˆ é™¤ç”¨æˆ·å¤±è´¥: {e}")
            return False

    def change_password(self, user_id: int, old_password: str, new_password: str) -> bool:
        """ä¿®æ”¹å¯†ç """
        try:
            user = self.get_user_by_id(user_id)
            if not user:
                return False

            # éªŒè¯æ—§å¯†ç 
            if not verify_password(old_password, user.password_hash):
                raise ValueError("åŸå¯†ç ä¸æ­£ç¡®")

            # æ›´æ–°å¯†ç 
            user.password_hash = get_password_hash(new_password)
            user.updated_at = datetime.utcnow()

            self.db.commit()

            logger.info(f"ä¿®æ”¹å¯†ç æˆåŠŸ: {user.username}")
            return True
        except Exception as e:
            self.db.rollback()
            logger.error(f"ä¿®æ”¹å¯†ç å¤±è´¥: {e}")
            raise

    def update_last_login(self, user_id: int) -> bool:
        """æ›´æ–°æœ€åç™»å½•æ—¶é—´"""
        try:
            user = self.get_user_by_id(user_id)
            if not user:
                return False

            user.last_login = datetime.utcnow()
            self.db.commit()

            return True
        except Exception as e:
            logger.error(f"æ›´æ–°æœ€åç™»å½•æ—¶é—´å¤±è´¥: {e}")
            return False
```

### APIè·¯ç”±å®ç°

#### 1. è®¤è¯è·¯ç”± (routers/auth.py)
```python
from fastapi import APIRouter, Depends, HTTPException, status
from fastapi.security import OAuth2PasswordRequestForm
from sqlalchemy.orm import Session
from datetime import timedelta

from ..core.database import get_db
from ..core.config import settings
from ..core.security import create_access_token, verify_token
from ..schemas.auth import Token, LoginResponse, RefreshTokenRequest
from ..schemas.user import UserResponse
from ..services.auth_service import authenticate_user, create_refresh_token_db
from ..services.user_service import UserService
from ..utils.logger import get_logger
from ..utils.dependencies import get_current_user

logger = get_logger(__name__)
router = APIRouter(prefix="/auth", tags=["è®¤è¯"])

@router.post("/login", response_model=LoginResponse, summary="ç”¨æˆ·ç™»å½•")
async def login(
    form_data: OAuth2PasswordRequestForm = Depends(),
    db: Session = Depends(get_db)
):
    """ç”¨æˆ·ç™»å½•æ¥å£"""
    try:
        logger.info(f"ç”¨æˆ·ç™»å½•å°è¯•: {form_data.username}")

        # éªŒè¯ç”¨æˆ·
        user = authenticate_user(db, form_data.username, form_data.password)
        if not user:
            logger.warning(f"ç™»å½•å¤±è´¥: ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ - {form_data.username}")
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯",
                headers={"WWW-Authenticate": "Bearer"},
            )

        if not user.is_active:
            logger.warning(f"ç™»å½•å¤±è´¥: ç”¨æˆ·å·²è¢«ç¦ç”¨ - {form_data.username}")
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="ç”¨æˆ·è´¦å·å·²è¢«ç¦ç”¨"
            )

        # åˆ›å»ºè®¿é—®ä»¤ç‰Œ
        access_token_expires = timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)
        access_token = create_access_token(
            data={"sub": str(user.id), "username": user.username},
            expires_delta=access_token_expires
        )

        # åˆ›å»ºåˆ·æ–°ä»¤ç‰Œ
        refresh_token = create_refresh_token_db(db, user.id)

        # æ›´æ–°æœ€åç™»å½•æ—¶é—´
        user_service = UserService(db)
        user_service.update_last_login(user.id)

        logger.info(f"ç”¨æˆ·ç™»å½•æˆåŠŸ: {user.username}")

        return LoginResponse(
            token=Token(
                access_token=access_token,
                refresh_token=refresh_token,
                token_type="bearer",
                expires_in=settings.ACCESS_TOKEN_EXPIRE_MINUTES * 60
            ),
            user=UserResponse.from_orm(user)
        )
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"ç™»å½•è¿‡ç¨‹å‡ºé”™: {e}")
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"
        )

@router.post("/refresh", response_model=Token, summary="åˆ·æ–°ä»¤ç‰Œ")
async def refresh_token(
    request: RefreshTokenRequest,
    db: Session = Depends(get_db)
):
    """åˆ·æ–°è®¿é—®ä»¤ç‰Œ"""
    try:
        # éªŒè¯åˆ·æ–°ä»¤ç‰Œ
        user = verify_token(request.refresh_token, db, token_type="refresh")
        if not user:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="æ— æ•ˆçš„åˆ·æ–°ä»¤ç‰Œ"
            )

        # åˆ›å»ºæ–°çš„è®¿é—®ä»¤ç‰Œ
        access_token_expires = timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)
        access_token = create_access_token(
            data={"sub": str(user.id), "username": user.username},
            expires_delta=access_token_expires
        )

        logger.info(f"ä»¤ç‰Œåˆ·æ–°æˆåŠŸ: {user.username}")

        return Token(
            access_token=access_token,
            refresh_token=request.refresh_token,
            token_type="bearer",
            expires_in=settings.ACCESS_TOKEN_EXPIRE_MINUTES * 60
        )
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"åˆ·æ–°ä»¤ç‰Œå¤±è´¥: {e}")
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="åˆ·æ–°ä»¤ç‰Œå¤±è´¥"
        )

@router.post("/logout", summary="ç”¨æˆ·ç™»å‡º")
async def logout(
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """ç”¨æˆ·ç™»å‡ºæ¥å£"""
    try:
        # TODO: å°†åˆ·æ–°ä»¤ç‰ŒåŠ å…¥é»‘åå•
        logger.info(f"ç”¨æˆ·ç™»å‡º: {current_user.username}")
        return {"message": "ç™»å‡ºæˆåŠŸ"}
    except Exception as e:
        logger.error(f"ç™»å‡ºå¤±è´¥: {e}")
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="ç™»å‡ºå¤±è´¥"
        )

@router.get("/me", response_model=UserResponse, summary="è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯")
async def get_current_user_info(
    current_user: User = Depends(get_current_user)
):
    """è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯"""
    return UserResponse.from_orm(current_user)
```

#### 2. ç”¨æˆ·ç®¡ç†è·¯ç”± (routers/users.py)
```python
from fastapi import APIRouter, Depends, HTTPException, status, Query
from sqlalchemy.orm import Session
from typing import Optional

from ..core.database import get_db
from ..schemas.user import (
    UserResponse, UserCreate, UserUpdate, UserListResponse, UserChangePassword
)
from ..services.user_service import UserService
from ..utils.dependencies import get_current_user, require_permission
from ..utils.logger import get_logger
from ..models.user import User

logger = get_logger(__name__)
router = APIRouter(prefix="/users", tags=["ç”¨æˆ·ç®¡ç†"])

@router.get("/", response_model=UserListResponse, summary="è·å–ç”¨æˆ·åˆ—è¡¨")
async def get_users(
    page: int = Query(1, ge=1, description="é¡µç "),
    size: int = Query(10, ge=1, le=100, description="æ¯é¡µæ•°é‡"),
    username: Optional[str] = Query(None, description="ç”¨æˆ·åæœç´¢"),
    email: Optional[str] = Query(None, description="é‚®ç®±æœç´¢"),
    is_active: Optional[bool] = Query(None, description="æ˜¯å¦å¯ç”¨"),
    db: Session = Depends(get_db),
    current_user: User = Depends(require_permission("user:read"))
):
    """è·å–ç”¨æˆ·åˆ—è¡¨"""
    try:
        user_service = UserService(db)
        skip = (page - 1) * size

        users, total = user_service.get_users(
            skip=skip,
            limit=size,
            username=username,
            email=email,
            is_active=is_active
        )

        return UserListResponse(
            items=[UserResponse.from_orm(user) for user in users],
            total=total,
            page=page,
            size=size
        )
    except Exception as e:
        logger.error(f"è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥: {e}")
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥"
        )

@router.get("/{user_id}", response_model=UserResponse, summary="è·å–ç”¨æˆ·è¯¦æƒ…")
async def get_user(
    user_id: int,
    db: Session = Depends(get_db),
    current_user: User = Depends(require_permission("user:read"))
):
    """è·å–ç”¨æˆ·è¯¦æƒ…"""
    try:
        user_service = UserService(db)
        user = user_service.get_user_by_id(user_id)

        if not user:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="ç”¨æˆ·ä¸å­˜åœ¨"
            )

        return UserResponse.from_orm(user)
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"è·å–ç”¨æˆ·è¯¦æƒ…å¤±è´¥: {e}")
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="è·å–ç”¨æˆ·è¯¦æƒ…å¤±è´¥"
        )

@router.post("/", response_model=UserResponse, summary="åˆ›å»ºç”¨æˆ·")
async def create_user(
    user_data: UserCreate,
    db: Session = Depends(get_db),
    current_user: User = Depends(require_permission("user:create"))
):
    """åˆ›å»ºç”¨æˆ·"""
    try:
        user_service = UserService(db)
        user = user_service.create_user(user_data)

        logger.info(f"åˆ›å»ºç”¨æˆ·æˆåŠŸ: {user.username}")
        return UserResponse.from_orm(user)
    except ValueError as e:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=str(e)
        )
    except Exception as e:
        logger.error(f"åˆ›å»ºç”¨æˆ·å¤±è´¥: {e}")
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="åˆ›å»ºç”¨æˆ·å¤±è´¥"
        )

@router.put("/{user_id}", response_model=UserResponse, summary="æ›´æ–°ç”¨æˆ·")
async def update_user(
    user_id: int,
    user_data: UserUpdate,
    db: Session = Depends(get_db),
    current_user: User = Depends(require_permission("user:update"))
):
    """æ›´æ–°ç”¨æˆ·"""
    try:
        user_service = UserService(db)
        user = user_service.update_user(user_id, user_data)

        if not user:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="ç”¨æˆ·ä¸å­˜åœ¨"
            )

        logger.info(f"æ›´æ–°ç”¨æˆ·æˆåŠŸ: {user.username}")
        return UserResponse.from_orm(user)
    except ValueError as e:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=str(e)
        )
    except Exception as e:
        logger.error(f"æ›´æ–°ç”¨æˆ·å¤±è´¥: {e}")
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="æ›´æ–°ç”¨æˆ·å¤±è´¥"
        )

@router.delete("/{user_id}", summary="åˆ é™¤ç”¨æˆ·")
async def delete_user(
    user_id: int,
    db: Session = Depends(get_db),
    current_user: User = Depends(require_permission("user:delete"))
):
    """åˆ é™¤ç”¨æˆ·"""
    try:
        user_service = UserService(db)
        success = user_service.delete_user(user_id)

        if not success:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="ç”¨æˆ·ä¸å­˜åœ¨"
            )

        logger.info(f"åˆ é™¤ç”¨æˆ·æˆåŠŸ: user_id={user_id}")
        return {"message": "ç”¨æˆ·åˆ é™¤æˆåŠŸ"}
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"åˆ é™¤ç”¨æˆ·å¤±è´¥: {e}")
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="åˆ é™¤ç”¨æˆ·å¤±è´¥"
        )

@router.post("/{user_id}/change-password", summary="ä¿®æ”¹å¯†ç ")
async def change_password(
    user_id: int,
    password_data: UserChangePassword,
    db: Session = Depends(get_db),
    current_user: User = Depends(require_permission("user:update"))
):
    """ä¿®æ”¹ç”¨æˆ·å¯†ç """
    try:
        # æ£€æŸ¥æƒé™ï¼šç”¨æˆ·åªèƒ½ä¿®æ”¹è‡ªå·±çš„å¯†ç ï¼Œæˆ–è€…æœ‰ç®¡ç†æƒé™
        if current_user.id != user_id and not current_user.is_superuser:
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail="æƒé™ä¸è¶³"
            )

        user_service = UserService(db)
        success = user_service.change_password(
            user_id, password_data.old_password, password_data.new_password
        )

        if not success:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="ç”¨æˆ·ä¸å­˜åœ¨"
            )

        logger.info(f"ä¿®æ”¹å¯†ç æˆåŠŸ: user_id={user_id}")
        return {"message": "å¯†ç ä¿®æ”¹æˆåŠŸ"}
    except ValueError as e:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=str(e)
        )
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"ä¿®æ”¹å¯†ç å¤±è´¥: {e}")
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="ä¿®æ”¹å¯†ç å¤±è´¥"
        )
```

### å®‰å…¨å·¥å…·å®ç°

#### 1. å¯†ç å’ŒJWTå¤„ç† (core/security.py)
```python
from datetime import datetime, timedelta
from typing import Optional, Union, Any
from jose import JWTError, jwt
from passlib.context import CryptContext
from fastapi import Depends, HTTPException, status
from fastapi.security import OAuth2PasswordBearer
from sqlalchemy.orm import Session

from .config import settings
from ..models.user import User
from ..core.database import get_db
from ..utils.logger import get_logger

logger = get_logger(__name__)

# å¯†ç åŠ å¯†ä¸Šä¸‹æ–‡
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

# OAuth2 scheme
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/api/auth/login")

def verify_password(plain_password: str, hashed_password: str) -> bool:
    """éªŒè¯å¯†ç """
    try:
        return pwd_context.verify(plain_password, hashed_password)
    except Exception as e:
        logger.error(f"å¯†ç éªŒè¯å¤±è´¥: {e}")
        return False

def get_password_hash(password: str) -> str:
    """è·å–å¯†ç å“ˆå¸Œ"""
    try:
        return pwd_context.hash(password)
    except Exception as e:
        logger.error(f"å¯†ç å“ˆå¸Œç”Ÿæˆå¤±è´¥: {e}")
        raise

def create_access_token(data: dict, expires_delta: Optional[timedelta] = None) -> str:
    """åˆ›å»ºè®¿é—®ä»¤ç‰Œ"""
    to_encode = data.copy()
    if expires_delta:
        expire = datetime.utcnow() + expires_delta
    else:
        expire = datetime.utcnow() + timedelta(minutes=15)

    to_encode.update({"exp": expire, "type": "access"})

    try:
        encoded_jwt = jwt.encode(to_encode, settings.SECRET_KEY, algorithm=settings.ALGORITHM)
        return encoded_jwt
    except Exception as e:
        logger.error(f"åˆ›å»ºè®¿é—®ä»¤ç‰Œå¤±è´¥: {e}")
        raise

def create_refresh_token(user_id: int, expires_delta: Optional[timedelta] = None) -> str:
    """åˆ›å»ºåˆ·æ–°ä»¤ç‰Œ"""
    if expires_delta:
        expire = datetime.utcnow() + expires_delta
    else:
        expire = datetime.utcnow() + timedelta(minutes=settings.REFRESH_TOKEN_EXPIRE_MINUTES)

    to_encode = {
        "sub": str(user_id),
        "exp": expire,
        "type": "refresh"
    }

    try:
        encoded_jwt = jwt.encode(to_encode, settings.SECRET_KEY, algorithm=settings.ALGORITHM)
        return encoded_jwt
    except Exception as e:
        logger.error(f"åˆ›å»ºåˆ·æ–°ä»¤ç‰Œå¤±è´¥: {e}")
        raise

def verify_token(token: str, db: Session, token_type: str = "access") -> Optional[User]:
    """éªŒè¯ä»¤ç‰Œ"""
    try:
        payload = jwt.decode(token, settings.SECRET_KEY, algorithms=[settings.ALGORITHM])

        # æ£€æŸ¥ä»¤ç‰Œç±»å‹
        if payload.get("type") != token_type:
            logger.warning(f"ä»¤ç‰Œç±»å‹ä¸åŒ¹é…: æœŸæœ›{token_type}, å®é™…{payload.get('type')}")
            return None

        user_id: str = payload.get("sub")
        if user_id is None:
            logger.warning("ä»¤ç‰Œä¸­ç¼ºå°‘ç”¨æˆ·ID")
            return None

        user = db.query(User).filter(User.id == int(user_id)).first()
        if user is None:
            logger.warning(f"ç”¨æˆ·ä¸å­˜åœ¨: {user_id}")
            return None

        if not user.is_active:
            logger.warning(f"ç”¨æˆ·å·²è¢«ç¦ç”¨: {user_id}")
            return None

        return user
    except JWTError as e:
        logger.warning(f"ä»¤ç‰ŒéªŒè¯å¤±è´¥: {e}")
        return None
    except Exception as e:
        logger.error(f"ä»¤ç‰ŒéªŒè¯è¿‡ç¨‹å‡ºé”™: {e}")
        return None

async def get_current_user(
    token: str = Depends(oauth2_scheme),
    db: Session = Depends(get_db)
) -> User:
    """è·å–å½“å‰ç”¨æˆ·"""
    credentials_exception = HTTPException(
        status_code=status.HTTP_401_UNAUTHORIZED,
        detail="æ— æ³•éªŒè¯å‡­æ®",
        headers={"WWW-Authenticate": "Bearer"},
    )

    user = verify_token(token, db, "access")
    if user is None:
        raise credentials_exception

    return user
```

### åº”ç”¨å…¥å£é…ç½®

#### 1. ä¸»åº”ç”¨æ–‡ä»¶ (main.py)
```python
from fastapi import FastAPI, Request, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse
from contextlib import asynccontextmanager
import uvicorn

from .core.config import settings
from .core.database import init_db
from .utils.logger import get_logger
from .routers import auth, users, roles, dashboard, system

logger = get_logger(__name__)

@asynccontextmanager
async def lifespan(app: FastAPI):
    """åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†"""
    # å¯åŠ¨æ—¶æ‰§è¡Œ
    logger.info("ğŸš€ åå°ç®¡ç†ç³»ç»Ÿå¯åŠ¨ä¸­...")

    try:
        # åˆå§‹åŒ–æ•°æ®åº“
        init_db()
        logger.info("âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ")

        # åº”ç”¨å¯åŠ¨å®Œæˆ
        logger.info(f"ğŸ‰ {settings.APP_NAME} v{settings.APP_VERSION} å¯åŠ¨æˆåŠŸ")
        logger.info(f"ğŸ“¡ æœåŠ¡è¿è¡Œåœ¨: http://{settings.HOST}:{settings.PORT}")
        logger.info(f"ğŸ“š APIæ–‡æ¡£: http://{settings.HOST}:{settings.PORT}/docs")

    except Exception as e:
        logger.error(f"âŒ åº”ç”¨å¯åŠ¨å¤±è´¥: {e}")
        raise

    yield

    # å…³é—­æ—¶æ‰§è¡Œ
    logger.info("ğŸ›‘ åå°ç®¡ç†ç³»ç»Ÿæ­£åœ¨å…³é—­...")

# åˆ›å»ºFastAPIåº”ç”¨
app = FastAPI(
    title=settings.APP_NAME,
    version=settings.APP_VERSION,
    description="åŸºäºFastAPI + Vue3çš„åå°ç®¡ç†ç³»ç»ŸDemo",
    lifespan=lifespan,
    docs_url="/docs" if settings.DEBUG else None,
    redoc_url="/redoc" if settings.DEBUG else None
)

# CORSä¸­é—´ä»¶
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.BACKEND_CORS_ORIGINS,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# å…¨å±€å¼‚å¸¸å¤„ç†
@app.exception_handler(HTTPException)
async def http_exception_handler(request: Request, exc: HTTPException):
    """HTTPå¼‚å¸¸å¤„ç†å™¨"""
    logger.warning(f"HTTPå¼‚å¸¸: {exc.status_code} - {exc.detail} - {request.url}")
    return JSONResponse(
        status_code=exc.status_code,
        content={
            "message": exc.detail,
            "status_code": exc.status_code,
            "path": str(request.url)
        }
    )

@app.exception_handler(Exception)
async def general_exception_handler(request: Request, exc: Exception):
    """é€šç”¨å¼‚å¸¸å¤„ç†å™¨"""
    logger.error(f"æœªå¤„ç†çš„å¼‚å¸¸: {type(exc).__name__} - {str(exc)} - {request.url}")
    return JSONResponse(
        status_code=500,
        content={
            "message": "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯" if not settings.DEBUG else str(exc),
            "status_code": 500,
            "path": str(request.url)
        }
    )

# è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶
@app.middleware("http")
async def log_requests(request: Request, call_next):
    """è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶"""
    start_time = time.time()

    # è®°å½•è¯·æ±‚
    logger.info(f"ğŸ“¤ {request.method} {request.url}")

    response = await call_next(request)

    # è®°å½•å“åº”
    process_time = time.time() - start_time
    logger.info(f"ğŸ“¥ {request.method} {request.url} - {response.status_code} - {process_time:.3f}s")

    return response

# æ³¨å†Œè·¯ç”±
app.include_router(auth.router, prefix="/api")
app.include_router(users.router, prefix="/api")
app.include_router(roles.router, prefix="/api")
app.include_router(dashboard.router, prefix="/api")
app.include_router(system.router, prefix="/api")

# æ ¹è·¯å¾„
@app.get("/")
async def root():
    """æ ¹è·¯å¾„"""
    return {
        "message": f"æ¬¢è¿ä½¿ç”¨{settings.APP_NAME}",
        "version": settings.APP_VERSION,
        "docs": "/docs"
    }

# å¥åº·æ£€æŸ¥
@app.get("/health")
async def health_check():
    """å¥åº·æ£€æŸ¥"""
    return {
        "status": "healthy",
        "version": settings.APP_VERSION,
        "timestamp": datetime.utcnow().isoformat()
    }

if __name__ == "__main__":
    uvicorn.run(
        "app.main:app",
        host=settings.HOST,
        port=settings.PORT,
        reload=settings.DEBUG,
        log_level="info"
    )
```

### æµ‹è¯•æ¡†æ¶é…ç½®

#### 1. æµ‹è¯•é…ç½® (tests/conftest.py)
```python
import pytest
import tempfile
import os
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from fastapi.testclient import TestClient

from app.main import app
from app.core.database import get_db, Base
from app.core.config import settings

# åˆ›å»ºä¸´æ—¶æ•°æ®åº“
@pytest.fixture(scope="session")
def test_db():
    """åˆ›å»ºæµ‹è¯•æ•°æ®åº“"""
    # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
    db_fd, db_path = tempfile.mkstemp()

    test_database_url = f"sqlite:///{db_path}"

    # åˆ›å»ºæµ‹è¯•å¼•æ“
    engine = create_engine(
        test_database_url,
        connect_args={"check_same_thread": False}
    )

    TestingSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

    # åˆ›å»ºè¡¨
    Base.metadata.create_all(bind=engine)

    # è¦†ç›–æ•°æ®åº“ä¾èµ–
    def override_get_db():
        try:
            db = TestingSessionLocal()
            yield db
        finally:
            db.close()

    app.dependency_overrides[get_db] = override_get_db

    yield TestingSessionLocal

    # æ¸…ç†
    os.close(db_fd)
    os.unlink(db_path)

@pytest.fixture
def client(test_db):
    """åˆ›å»ºæµ‹è¯•å®¢æˆ·ç«¯"""
    return TestClient(app)

@pytest.fixture
def test_user(test_db):
    """åˆ›å»ºæµ‹è¯•ç”¨æˆ·"""
    from app.services.user_service import UserService
    from app.schemas.user import UserCreate

    user_service = UserService(test_db)
    user_data = UserCreate(
        username="testuser",
        email="test@example.com",
        password="test123456",
        full_name="æµ‹è¯•ç”¨æˆ·"
    )

    return user_service.create_user(user_data)

@pytest.fixture
def auth_headers(client, test_user):
    """è·å–è®¤è¯å¤´"""
    response = client.post("/api/auth/login", data={
        "username": "testuser",
        "password": "test123456"
    })

    token = response.json()["token"]["access_token"]
    return {"Authorization": f"Bearer {token}"}
```

### éƒ¨ç½²é…ç½®

#### 1. è¿è¡Œè„šæœ¬ (run.py)
```python
import uvicorn
import os
import sys

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from app.core.config import settings
from app.utils.logger import get_logger

logger = get_logger(__name__)

def main():
    """å¯åŠ¨åº”ç”¨"""
    logger.info(f"æ­£åœ¨å¯åŠ¨ {settings.APP_NAME} v{settings.APP_VERSION}")

    try:
        uvicorn.run(
            "app.main:app",
            host=settings.HOST,
            port=settings.PORT,
            reload=settings.DEBUG,
            log_level=settings.LOG_LEVEL.lower(),
            access_log=True
        )
    except KeyboardInterrupt:
        logger.info("åº”ç”¨å·²åœæ­¢")
    except Exception as e:
        logger.error(f"å¯åŠ¨å¤±è´¥: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
```

### å¼€å‘è§„èŒƒ

#### 1. ä»£ç è§„èŒƒ
- ä½¿ç”¨Blackè¿›è¡Œä»£ç æ ¼å¼åŒ–
- ä½¿ç”¨isortè¿›è¡Œå¯¼å…¥æ’åº
- ä½¿ç”¨mypyè¿›è¡Œç±»å‹æ£€æŸ¥
- éµå¾ªPEP 8ç¼–ç è§„èŒƒ

#### 2. APIè®¾è®¡è§„èŒƒ
- RESTful APIè®¾è®¡åŸåˆ™
- ç»Ÿä¸€çš„å“åº”æ ¼å¼
- å®Œæ•´çš„é”™è¯¯å¤„ç†
- è¯¦ç»†çš„APIæ–‡æ¡£

#### 3. å®‰å…¨è§„èŒƒ
- è¾“å…¥æ•°æ®éªŒè¯
- SQLæ³¨å…¥é˜²æŠ¤
- XSSæ”»å‡»é˜²æŠ¤
- CSRFé˜²æŠ¤
- æƒé™éªŒè¯

#### 4. æ—¥å¿—è§„èŒƒ
- ç»“æ„åŒ–æ—¥å¿—æ ¼å¼
- åˆ†çº§æ—¥å¿—è®°å½•
- æ•æ„Ÿä¿¡æ¯è„±æ•
- æ“ä½œå®¡è®¡æ—¥å¿—

#### 5. æµ‹è¯•è§„èŒƒ
- å•å…ƒæµ‹è¯•è¦†ç›–
- é›†æˆæµ‹è¯•
- APIæµ‹è¯•
- æµ‹è¯•æ•°æ®ç®¡ç†